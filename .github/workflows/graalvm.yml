# WARNING: Do not edit this file directly. Instead, go to:
#
# https://github.com/micronaut-projects/micronaut-project-template/tree/master/.github/workflows
#
# and edit them there. Note that it will be sync'ed to all the Micronaut repos
name: GraalVM CE CI
on:
  push:
    branches:
      - master
      - '[1-9]+.[0-9]+.x'
  pull_request:
    branches:
      - master
      - '[1-9]+.[0-9]+.x'
jobs:
  build:
    if: github.repository != 'micronaut-projects/micronaut-project-template'
    runs-on: ubuntu-latest
    env:
      OCI_CLI_USER: ${{ secrets.OCI_USER }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_KEY_FILE }}
      OCI_CLI_REGION: ${{ secrets.OCI_REGION }}
    strategy:
      matrix:
        java: [ '17' ]
        graalvm: ['latest']
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Configure Kubectl
        uses: oracle-actions/configure-kubectl-oke@v1.3.1
        id: test-configure-kubectl-oke-action
        with:
          cluster: ${{ secrets.OKE_CLUSTER_OCID }}
      - name: Run Kubectl
        run: kubectl get nodes -A
      - name: Pre-build
        uses: ./.github/actions/graalvm-pre-build
        id: pre-build
        env:
          GRADLE_ENTERPRISE_ACCESS_KEY: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
          GRADLE_ENTERPRISE_CACHE_USERNAME: ${{ secrets.GRADLE_ENTERPRISE_CACHE_USERNAME }}
          GRADLE_ENTERPRISE_CACHE_PASSWORD: ${{ secrets.GRADLE_ENTERPRISE_CACHE_PASSWORD }}
          GIT_COMMIT_HASH: ${{ github.sha }}
          OCI_CLI_REGION: ${{ secrets.OCI_REGION }}
          JOB_ID: ${{ format('{0}-graalvm-java-{1}', github.run_id, matrix.java) }}
          OCI_TENANCY_NAME: ${{ secrets.OCI_TENANCY_NAME }}
          JAVA_VERSION: ${{ matrix.java }}
          AUTH_TOKEN: ${{ secrets.OCI_AUTH_TOKEN }}
          OCIR_USERNAME: ${{ secrets.OCIR_USERNAME }}
        with:
          java: ${{ matrix.java }}
          graalvm: ${{ matrix.graalvm }}
      - name: Build
        uses: ./.github/actions/graalvm-build
        id: build
        env:
          GH_TOKEN_PUBLIC_REPOS_READONLY: ${{ secrets.GH_TOKEN_PUBLIC_REPOS_READONLY }}
          GH_USERNAME: ${{ secrets.GH_USERNAME }}
          GRADLE_ENTERPRISE_ACCESS_KEY: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
          GRADLE_ENTERPRISE_CACHE_USERNAME: ${{ secrets.GRADLE_ENTERPRISE_CACHE_USERNAME }}
          GRADLE_ENTERPRISE_CACHE_PASSWORD: ${{ secrets.GRADLE_ENTERPRISE_CACHE_PASSWORD }}
          IMAGE_TAG: 'java-${{ matrix.java }}-${{ github.sha }}'
          IMAGE_PREFIX: '${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_TENANCY_NAME }}/'
          KUBERNETES_TRUST_CERTIFICATES: 'true'
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Post-build
        uses: ./.github/actions/graalvm-post-build
        if: always()
        id: post-build
        env:
          JOB_ID: ${{ format('{0}-graalvm-java-{1}', github.run_id, matrix.java) }}
        with:
          java: ${{ matrix.java }}
